<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书浏览 - 雀语图书馆</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#34D399',
                        secondary: '#10B981',
                        accent: '#059669',
                        light: '#ECFDF5',
                        dark: '#1E293B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        };
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow {
                box-shadow: 0 4px 6px -1px rgba(52, 211, 153, 0.1), 0 2px 4px -1px rgba(52, 211, 153, 0.06);
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
            }
            .btn-hover {
                @apply hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200;
            }
            .line-clamp-2 {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            .modal-show {
                transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col pb-16">
    <!-- 引入存储管理模块 -->
    <script src="utils/storage.js"></script>
    
    <!-- 顶部导航栏 -->
    <header class="bg-white sticky top-0 z-10 card-shadow">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fas fa-book text-primary text-xl"></i>
                <h1 class="text-lg font-bold text-dark">雀语图书馆</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="searchToggle" class="text-gray-600 hover:text-primary">
                    <i class="fas fa-search"></i>
                </button>
                <button id="notificationBtn" class="text-gray-600 hover:text-primary relative">
                    <i class="fas fa-bell"></i>
                    <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">3</span>
                </button>
                <div class="relative">
                    <button id="userMenuBtn" class="flex items-center space-x-1 text-gray-600">
                        <i class="fas fa-user-circle text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 搜索区域 -->
    <div id="searchContainer" class="bg-white px-4 py-3 border-b border-gray-100 hidden">
        <div class="container mx-auto">
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="搜索图书..." 
                    class="w-full py-2 pl-10 pr-4 bg-gray-50 border border-gray-200 rounded-lg input-focus"
                >
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                <button id="clearSearch" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 分类导航 -->
    <nav class="bg-white border-b border-gray-100 overflow-x-auto">
        <div class="container mx-auto px-4">
            <div class="flex space-x-6 py-3" id="categoryNav">
                <button class="whitespace-nowrap py-1 px-2 text-primary border-b-2 border-primary font-medium">全部</button>
                <button class="whitespace-nowrap py-1 px-2 text-gray-600 hover:text-primary">文学</button>
                <button class="whitespace-nowrap py-1 px-2 text-gray-600 hover:text-primary">科技</button>
                <button class="whitespace-nowrap py-1 px-2 text-gray-600 hover:text-primary">历史</button>
                <button class="whitespace-nowrap py-1 px-2 text-gray-600 hover:text-primary">艺术</button>
                <button class="whitespace-nowrap py-1 px-2 text-gray-600 hover:text-primary">教育</button>
                <button class="whitespace-nowrap py-1 px-2 text-gray-600 hover:text-primary">生活</button>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="flex-1 container mx-auto px-4 py-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-dark">热门推荐</h2>
            <div class="text-sm text-gray-500">共 <span id="bookCount">0</span> 本图书</div>
        </div>

        <!-- 图书展示区 -->
        <div id="bookGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-5">
            <!-- 图书将通过JavaScript动态生成 -->
        </div>

        <!-- 加载指示器 -->
        <div id="loadingIndicator" class="hidden py-8 flex justify-center">
            <div class="w-8 h-8 border-4 border-primary/30 border-t-primary rounded-full animate-spin"></div>
        </div>

        <!-- 空状态 -->
        <div id="emptyState" class="hidden py-12 text-center">
            <i class="fas fa-book-open text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">暂无图书数据</p>
        </div>
    </main>

    <!-- 底部导航 -->
    <footer class="bg-white fixed bottom-0 w-full border-t border-gray-200">
        <div class="container mx-auto">
            <div class="grid grid-cols-3 gap-1">
                <a href="books.html" class="flex flex-col items-center py-2 text-primary">
                    <i class="fas fa-home text-xl mb-1"></i>
                    <span class="text-xs">首页</span>
                </a>
                <a href="borrowed.html" class="flex flex-col items-center py-2 text-gray-500 hover:text-primary">
                    <i class="fas fa-bookmark text-xl mb-1"></i>
                    <span class="text-xs">借阅</span>
                </a>
                <a href="profile.html" class="flex flex-col items-center py-2 text-gray-500 hover:text-primary">
                    <i class="fas fa-user text-xl mb-1"></i>
                    <span class="text-xs">我的</span>
                </a>
            </div>
        </div>
    </footer>

    <!-- 弹窗组件 -->
    <div id="modalContainer"></div>

    <!-- 图书详情弹窗 -->
    <div id="bookModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-lg">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl transform transition-all duration-300 scale-95 opacity-0 modal-show">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-gray-800 to-black rounded-t-2xl">
                <h3 class="font-bold text-xl text-white">图书详情</h3>
                <button id="closeModal" class="text-white hover:text-gray-300 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modalContent" class="p-6">
                <!-- 内容将通过JavaScript动态填充 -->
            </div>
        </div>
    </div>

    <script>
        // 图书数据
        const booksData = [
            {
                id: '1',
                title: 'JavaScript高级程序设计',
                author: 'Nicholas C. Zakas',
                isbn: '9787115275790',
                category: '科技',
                publisher: '人民邮电出版社',
                publishDate: '2012-03-01',
                description: '本书是JavaScript经典图书的新版，全面介绍了JavaScript的核心概念和实践技巧。',
                coverImage: 'https://images.unsplash.com/photo-1532016923179-5bf2a0b0d0f1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80',
                totalCopies: 10,
                availableCopies: 5
            },
            {
                id: '2',
                title: '深入理解计算机系统',
                author: 'Randal E.Bryant',
                isbn: '9787111321330',
                category: '科技',
                publisher: '机械工业出版社',
                publishDate: '2016-11-01',
                description: '本书从程序员的角度详细阐述计算机系统的本质概念，并展示这些概念如何实实在在地影响应用程序的正确性、性能和实用性。',
                coverImage: 'https://images.unsplash.com/photo-1518770660439-4636190af475?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80',
                totalCopies: 8,
                availableCopies: 3
            },
            {
                id: '3',
                title: '百年孤独',
                author: '加西亚·马尔克斯',
                isbn: '9787544291170',
                category: '文学',
                publisher: '南海出版公司',
                publishDate: '2017-06-01',
                description: '《百年孤独》是魔幻现实主义文学的代表作，描写了布恩迪亚家族七代人的传奇故事。',
                coverImage: 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80',
                totalCopies: 12,
                availableCopies: 7
            },
            {
                id: '4',
                title: '人类简史',
                author: '尤瓦尔·赫拉利',
                isbn: '9787508647357',
                category: '历史',
                publisher: '中信出版社',
                publishDate: '2014-11-01',
                description: '本书以全新视角审视人类历史，讲述了从智人演化到现代人类的过程，以及人类社会的发展轨迹。',
                coverImage: 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80',
                totalCopies: 15,
                availableCopies: 9
            },
            {
                id: '5',
                title: '设计心理学',
                author: '唐纳德·诺曼',
                isbn: '9787508647358',
                category: '艺术',
                publisher: '中信出版社',
                publishDate: '2016-03-01',
                description: '本书解释了为什么我们的日常生活充满了困扰，以及设计师应该如何改善用户的体验。',
                coverImage: 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80',
                totalCopies: 6,
                availableCopies: 2
            },
            {
                id: '6',
                title: '原则',
                author: '瑞·达利欧',
                isbn: '9787508681057',
                category: '教育',
                publisher: '中信出版社',
                publishDate: '2018-01-01',
                description: '桥水基金创始人分享其生活和工作的原则，帮助读者在面对人生和职业挑战时做出更好的决策。',
                coverImage: 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80',
                totalCopies: 10,
                availableCopies: 6
            }
        ];

        // 确保图片正确加载
        function handleImageError(img) {
            img.onerror = null;
            img.src = 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80';
        }

        // DOM元素
        const bookGrid = document.getElementById('bookGrid');
        const bookCount = document.getElementById('bookCount');
        const searchInput = document.getElementById('searchInput');
        const searchContainer = document.getElementById('searchContainer');
        const searchToggle = document.getElementById('searchToggle');
        const clearSearch = document.getElementById('clearSearch');
        const bookModal = document.getElementById('bookModal');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal');
        const categoryNav = document.getElementById('categoryNav');

        // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 检查登录状态
        if (!StorageManager.isLoggedIn()) {
            window.location.href = 'login.html';
            return;
        }

        // 显示用户名
        const userInfo = StorageManager.getUserInfo();
        if (userInfo) {
            document.title = `欢迎，${userInfo.username} - 雀语图书馆`;
        }

        // 动态加载弹窗组件
        fetch('components/modal.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('modalContainer').innerHTML = html;
                // 绑定事件
                bindEvents();
                // 渲染图书
                renderBooks(booksData);
            })
            .catch(error => {
                console.error('加载弹窗组件失败:', error);
                // 即使弹窗组件加载失败，也要绑定事件
                bindEvents();
                // 渲染图书
                renderBooks(booksData);
            });
    });

        // 绑定事件
        function bindEvents() {
            // 搜索切换
            searchToggle.addEventListener('click', function() {
                searchContainer.classList.toggle('hidden');
                if (!searchContainer.classList.contains('hidden')) {
                    searchInput.focus();
                }
            });

            // 搜索输入
            searchInput.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    clearSearch.classList.remove('hidden');
                } else {
                    clearSearch.classList.add('hidden');
                }
                filterBooks(this.value);
            });

            // 清除搜索
            clearSearch.addEventListener('click', function() {
                searchInput.value = '';
                clearSearch.classList.add('hidden');
                renderBooks(booksData);
            });

            // 关闭模态框
        closeModal.addEventListener('click', function() {
            closeModalHandler();
        });

        // 点击模态框外部关闭
        bookModal.addEventListener('click', function(e) {
            if (e.target === bookModal) {
                closeModalHandler();
            }
        });
        
        // 关闭模态框处理函数
        function closeModalHandler() {
            const modalDialog = bookModal.querySelector('div');
            modalDialog.classList.remove('scale-100', 'opacity-100');
            modalDialog.classList.add('scale-95', 'opacity-0');
            
            // 延迟隐藏整个模态框以允许动画完成
            setTimeout(() => {
                bookModal.classList.add('hidden');
            }, 300);
        }

            // 分类导航点击
            categoryNav.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON') {
                    // 移除所有按钮的激活状态
                    document.querySelectorAll('#categoryNav button').forEach(btn => {
                        btn.classList.remove('text-primary', 'border-b-2', 'border-primary');
                        btn.classList.add('text-gray-600');
                    });
                    
                    // 激活当前按钮
                    e.target.classList.remove('text-gray-600');
                    e.target.classList.add('text-primary', 'border-b-2', 'border-primary');
                    
                    // 根据分类过滤图书
                    const category = e.target.textContent;
                    if (category === '全部') {
                        renderBooks(booksData);
                    } else {
                        const filtered = booksData.filter(book => book.category === category);
                        renderBooks(filtered);
                    }
                }
            });
        }

        // 渲染图书
        function renderBooks(books) {
            bookGrid.innerHTML = '';
            bookCount.textContent = books.length;

            if (books.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }

            document.getElementById('emptyState').classList.add('hidden');

            books.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'bg-white rounded-xl card-shadow overflow-hidden btn-hover transform transition-transform duration-300 hover:-translate-y-1';
                bookCard.innerHTML = `
                    <div class="aspect-[2/3] overflow-hidden">
                        <img src="${book.coverImage}" alt="${book.title}" class="w-full h-full object-cover" onerror="handleImageError(this)">
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-sm mb-1.5 line-clamp-2">${book.title}</h3>
                        <p class="text-xs text-gray-500 mb-3 truncate">${book.author}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-medium ${book.availableCopies > 0 ? 'text-primary' : 'text-red-500'}">
                                ${book.availableCopies > 0 ? `可借: ${book.availableCopies}` : '已借完'}
                            </span>
                            <div class="flex space-x-2">
                                <button class="reserve-btn text-xs bg-gradient-to-r from-primary to-secondary text-white px-3 py-1.5 rounded-lg shadow-sm" 
                                        data-id="${book.id}">
                                    预约
                                </button>
                                <button class="favorite-btn text-xs bg-gray-200 text-gray-700 px-3 py-1.5 rounded-lg shadow-sm" 
                                        data-id="${book.id}">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                bookGrid.appendChild(bookCard);

                // 添加点击事件
                bookCard.addEventListener('click', function(e) {
                    // 如果点击的是预约按钮，则处理预约逻辑
                    if (e.target.classList.contains('reserve-btn') || (e.target.parentElement && e.target.parentElement.classList.contains('reserve-btn'))) {
                        handleReserve(book.id);
                        return;
                    }
                    
                    // 如果点击的是收藏按钮，则处理收藏逻辑
                    if (e.target.classList.contains('favorite-btn') || e.target.classList.contains('fa-heart') || (e.target.parentElement && e.target.parentElement.classList.contains('favorite-btn'))) {
                        handleFavorite(book.id);
                        const favoriteBtn = e.target.classList.contains('favorite-btn') ? e.target : 
                                            e.target.classList.contains('fa-heart') ? e.target.parentElement : 
                                            e.target.parentElement;
                        toggleFavoriteButton(favoriteBtn, isBookFavorited(book.id));
                        return;
                    }
                    
                    // 否则显示详情
                    showBookDetails(book);
                });
            });
        }

        // 过滤图书
        function filterBooks(keyword) {
            const filtered = booksData.filter(book => 
                book.title.toLowerCase().includes(keyword.toLowerCase()) ||
                book.author.toLowerCase().includes(keyword.toLowerCase()) ||
                book.category.toLowerCase().includes(keyword.toLowerCase())
            );
            renderBooks(filtered);
        }

        // 显示图书详情
        function showBookDetails(book) {
            modalContent.innerHTML = `
                <div class="flex flex-col sm:flex-row gap-6 mb-6">
                    <div class="sm:w-1/3">
                        <img src="${book.coverImage}" alt="${book.title}" class="w-full rounded-2xl shadow-lg" onerror="handleImageError(this)">
                    </div>
                    <div class="sm:w-2/3">
                        <h3 class="font-bold text-xl mb-4 text-gray-900">${book.title}</h3>
                        <div class="space-y-3 mb-5">
                            <p class="text-gray-800 text-sm flex">
                                <span class="text-gray-900 font-medium w-16">作者：</span>
                                <span>${book.author}</span>
                            </p>
                            <p class="text-gray-800 text-sm flex">
                                <span class="text-gray-900 font-medium w-16">分类：</span>
                                <span class="inline-block px-3 py-1 bg-primary/10 text-primary rounded-full text-xs">${book.category}</span>
                            </p>
                            <p class="text-gray-800 text-sm flex">
                                <span class="text-gray-900 font-medium w-16">出版社：</span>
                                <span>${book.publisher}</span>
                            </p>
                            <p class="text-gray-800 text-sm flex">
                                <span class="text-gray-900 font-medium w-16">出版日期：</span>
                                <span>${book.publishDate}</span>
                            </p>
                            <p class="text-gray-800 text-sm flex">
                                <span class="text-gray-900 font-medium w-16">ISBN：</span>
                                <span>${book.isbn}</span>
                            </p>
                            <p class="text-gray-800 text-sm flex items-center">
                                <span class="text-gray-900 font-medium w-16">库存：</span>
                                <span class="inline-flex items-center">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-medium ${book.availableCopies > 0 ? 'bg-green-700 text-white' : 'bg-red-700 text-white'}">
                                        ${book.availableCopies}/${book.totalCopies} (${book.availableCopies > 0 ? '可借' : '已借完'})
                                    </span>
                                </span>
                            </p>
                        </div>
                        <div class="flex space-x-3">
                            <button class="reserve-btn flex-1 bg-gradient-to-r from-primary to-secondary text-white py-3.5 rounded-xl font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300" 
                                    data-id="${book.id}">
                                预约图书
                            </button>
                            <button class="favorite-btn w-12 bg-gray-200 text-gray-700 py-3.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all duration-300" 
                                    data-id="${book.id}">
                                <i class="fas fa-heart text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 绑定预约按钮事件
            const reserveBtn = modalContent.querySelector('.reserve-btn');
            if (reserveBtn) {
                reserveBtn.addEventListener('click', function() {
                    handleReserve(book.id);
                });
            }
            
            // 绑定收藏按钮事件
            const favoriteBtn = modalContent.querySelector('.favorite-btn');
            if (favoriteBtn) {
                favoriteBtn.addEventListener('click', function() {
                    handleFavorite(book.id);
                    toggleFavoriteButton(favoriteBtn, isBookFavorited(book.id));
                });
            }
            
            // 设置收藏按钮初始状态
            const bookId = book.id;
            if (isBookFavorited(bookId)) {
                const favBtns = modalContent.querySelectorAll('.favorite-btn');
                favBtns.forEach(btn => toggleFavoriteButton(btn, true));
            }
            
            // 显示弹窗并添加动画效果
            bookModal.classList.remove('hidden');
            setTimeout(() => {
                const modalDialog = bookModal.querySelector('div');
                modalDialog.classList.remove('scale-95', 'opacity-0');
                modalDialog.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 处理借阅
        function handleBorrow(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book) {
                if (typeof GlobalModalManager !== 'undefined' && GlobalModalManager.message) {
                    GlobalModalManager.message('未找到该图书');
                } else {
                    alert('未找到该图书');
                }
                return;
            }
            
            if (book.availableCopies <= 0) {
                if (typeof GlobalModalManager !== 'undefined' && GlobalModalManager.message) {
                    GlobalModalManager.message('该图书已借完');
                } else {
                    alert('该图书已借完');
                }
                return;
            }
            
            // 确认借阅
            if (typeof GlobalModalManager !== 'undefined' && GlobalModalManager.show) {
                GlobalModalManager.show(`确定要借阅《${book.title}》吗？`, function() {
                
                    // 创建借阅记录
                    const borrowedBooks = StorageManager.getBorrowedBooks();
                    const borrowRecord = {
                        bookId: book.id,
                        bookTitle: book.title,
                        borrowDate: new Date().toISOString().split('T')[0],
                        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30天后到期
                        returned: false
                    };
                    
                    borrowedBooks.push(borrowRecord);
                    StorageManager.saveBorrowedBooks(borrowedBooks);
                    
                    // 更新图书库存
                    book.availableCopies--;
                    
                    // 重新渲染
                    const keyword = searchInput.value.trim();
                    if (keyword) {
                        filterBooks(keyword);
                    } else {
                        renderBooks(booksData);
                    }
                    
                    // 关闭模态框并提示
                    bookModal.classList.add('hidden');
                    GlobalModalManager.message(`《${book.title}》借阅成功！请在${borrowRecord.dueDate}前归还。`);
                });
            } else {
                if (confirm(`确定要借阅《${book.title}》吗？`)) {
                    // 创建借阅记录
                    const borrowedBooks = StorageManager.getBorrowedBooks();
                    const borrowRecord = {
                        bookId: book.id,
                        bookTitle: book.title,
                        borrowDate: new Date().toISOString().split('T')[0],
                        dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30天后到期
                        returned: false
                    };
                    
                    borrowedBooks.push(borrowRecord);
                    StorageManager.saveBorrowedBooks(borrowedBooks);
                    
                    // 更新图书库存
                    book.availableCopies--;
                    
                    // 重新渲染
                    const keyword = searchInput.value.trim();
                    if (keyword) {
                        filterBooks(keyword);
                    } else {
                        renderBooks(booksData);
                    }
                    
                    // 关闭模态框并提示
                    bookModal.classList.add('hidden');
                    alert(`《${book.title}》借阅成功！请在${borrowRecord.dueDate}前归还。`);
                }
            }
        }
        
        // 处理预约
        function handleReserve(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book) {
                if (typeof GlobalModalManager !== 'undefined' && GlobalModalManager.message) {
                    GlobalModalManager.message('未找到该图书');
                } else {
                    alert('未找到该图书');
                }
                return;
            }
            
            // 检查是否已经预约过这本书
            const reservations = StorageManager.getReservations();
            const existingReservation = reservations.find(r => r.bookId === bookId && !r.completed);
            if (existingReservation) {
                if (typeof GlobalModalManager !== 'undefined' && GlobalModalManager.message) {
                    GlobalModalManager.message('您已经预约过这本书，请前往图书馆办理借阅手续');
                } else {
                    alert('您已经预约过这本书，请前往图书馆办理借阅手续');
                }
                return;
            }
            
            // 确认预约
            if (typeof GlobalModalManager !== 'undefined' && GlobalModalManager.show) {
                GlobalModalManager.show(`确定要预约《${book.title}》吗？预约成功后请前往图书馆办理借阅手续。`, function() {
                
                    // 创建预约记录
                    const reservationRecord = {
                        bookId: book.id,
                        bookTitle: book.title,
                        reserveDate: new Date().toISOString().split('T')[0],
                        completed: false
                    };
                    
                    reservations.push(reservationRecord);
                    StorageManager.saveReservations(reservations);
                    
                    // 关闭模态框并提示
                    bookModal.classList.add('hidden');
                    GlobalModalManager.message(`《${book.title}》预约成功！请前往图书馆办理借阅手续。`);
                });
            } else {
                if (confirm(`确定要预约《${book.title}》吗？预约成功后请前往图书馆办理借阅手续。`)) {
                    // 创建预约记录
                    const reservationRecord = {
                        bookId: book.id,
                        bookTitle: book.title,
                        reserveDate: new Date().toISOString().split('T')[0],
                        completed: false
                    };
                    
                    reservations.push(reservationRecord);
                    StorageManager.saveReservations(reservations);
                    
                    // 关闭模态框并提示
                    bookModal.classList.add('hidden');
                    alert(`《${book.title}》预约成功！请前往图书馆办理借阅手续。`);
                }
            }
        }
        
        // 处理收藏
        function handleFavorite(bookId) {
            const favorites = StorageManager.getFavoriteBooks();
            const bookIndex = favorites.indexOf(bookId);
            
            if (bookIndex > -1) {
                // 取消收藏
                favorites.splice(bookIndex, 1);
            } else {
                // 添加收藏
                favorites.push(bookId);
            }
            
            StorageManager.saveFavoriteBooks(favorites);
            
            // 显示提示
            const isFavorited = bookIndex === -1;
            if (typeof GlobalModalManager !== 'undefined' && GlobalModalManager.message) {
                GlobalModalManager.message(isFavorited ? '已添加到收藏' : '已取消收藏');
            } else {
                alert(isFavorited ? '已添加到收藏' : '已取消收藏');
            }
        }
        
        // 检查图书是否已被收藏
        function isBookFavorited(bookId) {
            const favorites = StorageManager.getFavoriteBooks();
            return favorites.includes(bookId);
        }
        
        // 切换收藏按钮状态
        function toggleFavoriteButton(button, isFavorited) {
            const heartIcon = button.querySelector('.fa-heart');
            if (isFavorited) {
                button.classList.remove('bg-gray-200', 'text-gray-700');
                button.classList.add('bg-red-500', 'text-white');
                if (heartIcon) {
                    heartIcon.classList.remove('far');
                    heartIcon.classList.add('fas');
                }
            } else {
                button.classList.remove('bg-red-500', 'text-white');
                button.classList.add('bg-gray-200', 'text-gray-700');
                if (heartIcon) {
                    heartIcon.classList.remove('fas');
                    heartIcon.classList.add('far');
                }
            }
        }
    </script>
</body>
</html>
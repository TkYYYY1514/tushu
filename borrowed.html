<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的借阅 - 雀语图书馆</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#34D399',
                        secondary: '#10B981',
                        accent: '#059669',
                        neutral: '#F5F5F5',
                        light: '#FFFFFF',
                        dark: '#1E293B'
                    },
                    fontFamily: {
                        sans: ['PingFang SC', 'Helvetica Neue', 'Arial', 'sans-serif']
                    }
                }
            }
        };
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-scale {
                @apply transition-transform duration-300;
            }
            .btn-scale:active {
                @apply transform scale-105;
            }
            .card-shadow {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }
            .badge {
                @apply px-2 py-1 rounded-full text-xs font-medium;
            }
            /* 消息卡片样式 */
            .message-card {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                max-width: 300px;
                transform: translateX(120%);
                transition: transform 0.3s ease-out;
            }
            .message-card.show {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="bg-neutral text-dark font-sans min-h-screen flex flex-col pb-16">
    <!-- 引入存储管理模块 -->
    <script src="utils/storage.js"></script>
    
    <!-- 页面标题栏 -->
    <div class="bg-white shadow-sm py-3 px-4 sticky top-0 z-10">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-bold text-dark">
                我的借阅
            </h2>
            <button id="refreshBtn" class="text-gray-600 hover:text-primary">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <main class="flex-1 container mx-auto px-4 py-4">
        <!-- 逾期提醒横幅 -->
        <div id="overdueBanner" class="hidden bg-red-100 border-l-4 border-red-500 p-4 mb-4 rounded">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
                <div class="flex-1">
                    <p class="text-red-700 font-medium">您有逾期未还的书籍!</p>
                    <p class="text-red-600 text-sm">请尽快前往图书馆办理还书手续，避免产生更多罚款。</p>
                </div>
                <button id="closeOverdueBanner" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        


        <!-- 分类导航 -->
        <div class="bg-white rounded-lg p-2 card-shadow mb-4">
            <div class="flex overflow-x-auto space-x-4 py-1" id="categoryTabs">
                <button class="tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 bg-primary text-white active" 
                        data-tab="all">全部</button>
                <button class="tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 text-gray-600" 
                        data-tab="reservation">预约记录</button>
                <button class="tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 text-gray-600" 
                        data-tab="borrowed">借阅记录</button>
                <button class="tab-btn whitespace-nowrap px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 text-gray-600" 
                        data-tab="favorite">我的收藏</button>
            </div>
        </div>

        <!-- 加载指示器 -->
        <div id="loadingIndicator" class="py-8 flex justify-center hidden">
            <div class="text-center">
                <div class="inline-block relative w-12 h-12 mb-4">
                    <div class="absolute w-12 h-12 border-4 border-primary/30 rounded-full animate-spin"></div>
                    <div class="absolute w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                </div>
                <p class="text-gray-600">正在加载...</p>
            </div>
        </div>

        <!-- 记录列表 -->
        <div id="recordsContainer">
            <!-- 预约记录 -->
            <div id="reservationSection" class="tab-content">
                <h3 class="font-bold text-lg mb-3 flex items-center">
                    <i class="fas fa-calendar-plus text-yellow-500 mr-2"></i>预约记录
                </h3>
                <div id="reservationList" class="space-y-3">
                    <!-- 预约记录将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 借阅记录 -->
            <div id="borrowedSection" class="tab-content hidden">
                <!-- 逾期书籍 -->
                <div class="mb-6">
                    <h3 class="font-bold text-lg mb-3 flex items-center">
                        <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>逾期书籍
                    </h3>
                    <div id="overdueList" class="space-y-3">
                        <!-- 逾期书籍将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 正常借阅中的书籍 -->
                <div>
                    <h3 class="font-bold text-lg mb-3 flex items-center">
                        <i class="fas fa-book-reader text-blue-500 mr-2"></i>借阅中
                    </h3>
                    <div id="normalBorrowedList" class="space-y-3">
                        <!-- 借阅中书籍将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 收藏记录 -->
            <div id="favoriteSection" class="tab-content hidden">
                <h3 class="font-bold text-lg mb-3 flex items-center">
                    <i class="fas fa-heart text-purple-500 mr-2"></i>我的收藏
                </h3>
                <div id="favoriteList" class="space-y-3">
                    <!-- 收藏记录将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 空状态 -->
        <div id="emptyState" class="hidden py-12 text-center">
            <i class="fas fa-book-open text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">暂无相关记录</p>
        </div>
    </main>

    <!-- 弹窗组件 -->
    <div id="modalContainer"></div>
    
    <!-- 消息卡片容器 -->
    <div id="messageCardContainer"></div>
    
    <!-- 底部导航 -->
    <footer class="bg-white fixed bottom-0 w-full border-t border-gray-200">
        <div class="container mx-auto">
            <div class="grid grid-cols-3 gap-1">
                <a href="books.html" class="flex flex-col items-center py-2 text-gray-500 hover:text-primary">
                    <i class="fas fa-home text-xl mb-1"></i>
                    <span class="text-xs">首页</span>
                </a>
                <a href="borrowed.html" class="flex flex-col items-center py-2 text-primary">
                    <i class="fas fa-bookmark text-xl mb-1"></i>
                    <span class="text-xs">借阅</span>
                </a>
                <a href="profile.html" class="flex flex-col items-center py-2 text-gray-500 hover:text-primary">
                    <i class="fas fa-user text-xl mb-1"></i>
                    <span class="text-xs">我的</span>
                </a>
            </div>
        </div>
    </footer>

    <script>
        // DOM元素
        const categoryTabs = document.getElementById('categoryTabs');
        const tabContents = document.querySelectorAll('.tab-content');
        const reservationList = document.getElementById('reservationList');
        const overdueList = document.getElementById('overdueList');
        const normalBorrowedList = document.getElementById('normalBorrowedList');
        const favoriteList = document.getElementById('favoriteList');
        const emptyState = document.getElementById('emptyState');
        const recordsContainer = document.getElementById('recordsContainer');
        const overdueBanner = document.getElementById('overdueBanner');
        const closeOverdueBanner = document.getElementById('closeOverdueBanner');
        const refreshBtn = document.getElementById('refreshBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否在SPA环境中运行
            const isSPA = document.getElementById('appContent') !== null;
            
            // 如果不在SPA环境中，才执行原有的登录检查和初始化
            if (!isSPA) {
                // 检查登录状态
                if (!StorageManager.isLoggedIn()) {
                    window.location.href = 'login.html';
                    return;
                }
            }

            // 显示加载指示器
            if (loadingIndicator) {
                loadingIndicator.classList.remove('hidden');
                recordsContainer.classList.add('hidden');
            }


            
            // 显示所有分类
            showAllCategories();

            // 动态加载弹窗组件（如果不是在SPA环境中）
            if (!isSPA) {
                fetch('components/modal.html')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('modalContainer').innerHTML = html;
                        bindEvents();
                        // 加载内容
                        loadContent();
                    })
                    .catch(error => {
                        console.error('加载弹窗组件失败:', error);
                        bindEvents();
                        // 加载内容
                        loadContent();
                    });
            } else {
                // 在SPA环境中直接绑定事件和加载内容
                bindEvents();
                loadContent();
            }
        });

        // 加载内容
        function loadContent() {
            // 模拟加载延迟
            setTimeout(() => {
                renderReservations();
                renderBorrowedBooks();
                renderFavorites();
                
                // 隐藏加载指示器
                if (loadingIndicator) {
                    loadingIndicator.classList.add('hidden');
                    recordsContainer.classList.remove('hidden');
                }
                
                // 更新空状态
                updateEmptyState();
            }, 500);
        }

        // 更新统计信息
        function updateStats() {
            const borrowedBooks = StorageManager.getBorrowedBooks();
            
            // 检查是否有逾期书籍
            const overdueBooks = borrowedBooks.filter(record => {
                const today = new Date();
                const dueDate = new Date(record.dueDate);
                return dueDate < today && !record.returned;
            });
            
            if (overdueBooks.length > 0) {
                overdueBanner.classList.remove('hidden');
            } else {
                overdueBanner.classList.add('hidden');
            }
        }

        // 显示所有分类
        function showAllCategories() {
            // 显示所有内容区域
            tabContents.forEach(content => {
                content.classList.remove('hidden');
            });
            
            // 更新空状态
            updateEmptyState();
        }

        // 渲染预约记录
        function renderReservations() {
            const reservations = StorageManager.getReservations().filter(r => !r.completed);
            reservationList.innerHTML = '';
            
            if (reservations.length === 0) {
                reservationList.innerHTML = `
                    <div class="bg-white rounded-lg p-6 card-shadow text-center">
                        <i class="fas fa-calendar-plus text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">暂无预约记录</p>
                    </div>
                `;
                return;
            }
            
            reservations.forEach(reservation => {
                const reservationElement = document.createElement('div');
                reservationElement.className = 'bg-white rounded-lg p-4 card-shadow';
                reservationElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-gray-900">${reservation.bookTitle}</h4>
                            <p class="text-sm text-gray-600 mt-1">预约日期: ${reservation.reserveDate}</p>
                        </div>
                        <button class="cancel-reservation-btn text-red-500 hover:text-red-700 btn-scale" data-id="${reservation.bookId}">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                        <span class="badge bg-yellow-100 text-yellow-800">预约中</span>
                        <button class="bg-primary hover:bg-primary/90 text-white px-3 py-1 rounded-lg text-sm btn-scale borrow-now-btn" data-id="${reservation.bookId}">
                            立即借阅
                        </button>
                    </div>
                `;
                reservationList.appendChild(reservationElement);
            });
        }

        // 渲染借阅记录
        function renderBorrowedBooks() {
            const borrowedBooks = StorageManager.getBorrowedBooks().filter(b => !b.returned);
            const today = new Date();
            
            // 分离逾期和正常借阅的书籍
            const overdueBooks = [];
            const normalBooks = [];
            
            borrowedBooks.forEach(book => {
                const dueDate = new Date(book.dueDate);
                if (dueDate < today) {
                    overdueBooks.push(book);
                } else {
                    normalBooks.push(book);
                }
            });
            
            // 渲染逾期书籍
            overdueList.innerHTML = '';
            if (overdueBooks.length === 0) {
                document.querySelector('#borrowedSection > div:first-child').classList.add('hidden');
            } else {
                document.querySelector('#borrowedSection > div:first-child').classList.remove('hidden');
                overdueBooks.forEach(book => {
                    const daysOverdue = Math.ceil((today - new Date(book.dueDate)) / (1000 * 60 * 60 * 24));
                    const fine = (daysOverdue * 0.5).toFixed(1);
                    
                    const bookElement = document.createElement('div');
                    bookElement.className = 'bg-white rounded-lg p-4 card-shadow border-l-4 border-red-500';
                    bookElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-gray-900">${book.bookTitle}</h4>
                                <p class="text-sm text-gray-600 mt-1">借阅日期: ${book.borrowDate}</p>
                                <p class="text-sm text-gray-600">应还日期: ${book.dueDate}</p>
                                <p class="text-sm text-red-600 font-medium mt-1">逾期天数: ${daysOverdue}天</p>
                            </div>
                            <button class="return-book-btn text-red-500 hover:text-red-700 btn-scale" data-id="${book.bookId}">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                        <div class="mt-3 flex justify-between items-center">
                            <span class="badge bg-red-100 text-red-800">已逾期</span>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">罚款金额</p>
                                <p class="text-lg font-bold text-red-500">¥${fine}</p>
                            </div>
                        </div>
                    `;
                    overdueList.appendChild(bookElement);
                });
            }
            
            // 渲染正常借阅中的书籍
            normalBorrowedList.innerHTML = '';
            if (normalBooks.length === 0) {
                normalBorrowedList.innerHTML = `
                    <div class="bg-white rounded-lg p-6 card-shadow text-center">
                        <i class="fas fa-book-reader text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">暂无借阅中的书籍</p>
                    </div>
                `;
            } else {
                normalBooks.forEach(book => {
                    const dueDate = new Date(book.dueDate);
                    const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    
                    const bookElement = document.createElement('div');
                    bookElement.className = 'bg-white rounded-lg p-4 card-shadow';
                    bookElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-gray-900">${book.bookTitle}</h4>
                                <p class="text-sm text-gray-600 mt-1">借阅日期: ${book.borrowDate}</p>
                                <p class="text-sm text-gray-600">应还日期: ${book.dueDate}</p>
                                ${book.renewalCount > 0 ? '<p class="text-sm text-gray-600">已续借</p>' : ''}
                            </div>
                            <button class="return-book-btn text-red-500 hover:text-red-700 btn-scale" data-id="${book.bookId}">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                        <div class="mt-3 flex justify-between items-center">
                            <span class="badge bg-blue-100 text-blue-800">借阅中</span>
                            <div class="flex space-x-2">
                                ${book.renewalCount === 0 ? 
                                `<button class="renew-book-btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-lg text-sm btn-scale" data-id="${book.bookId}">
                                    续借
                                </button>` : 
                                `<span class="text-sm text-gray-500">已续借</span>`}
                                <div class="text-right">
                                    <p class="text-sm text-gray-600">剩余天数</p>
                                    <p class="text-lg font-bold ${daysLeft <= 3 ? 'text-red-500' : 'text-green-500'}">${daysLeft}天</p>
                                </div>
                            </div>
                        </div>
                    `;
                    normalBorrowedList.appendChild(bookElement);
                });
            }
            
            // 绑定续借按钮事件
            document.querySelectorAll('.renew-book-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const bookId = this.getAttribute('data-id');
                    renewBook(bookId);
                });
            });
        }

        // 渲染收藏记录
        function renderFavorites() {
            const favoriteBooks = StorageManager.getFavoriteBooks();
            favoriteList.innerHTML = '';
            
            if (favoriteBooks.length === 0) {
                favoriteList.innerHTML = `
                    <div class="bg-white rounded-lg p-6 card-shadow text-center">
                        <i class="fas fa-heart text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">暂无收藏记录</p>
                    </div>
                `;
                return;
            }
            
            // 这里简化处理，实际项目中应该从图书数据中获取详细信息
            const booksData = [
                { id: '1', title: 'JavaScript高级程序设计' },
                { id: '2', title: '深入理解计算机系统' },
                { id: '3', title: '百年孤独' },
                { id: '4', title: '人类简史' },
                { id: '5', title: '设计心理学' },
                { id: '6', title: '原则' },
                { id: '7', title: '代码大全' },
                { id: '8', title: '重构：改善既有代码的设计' },
                { id: '9', title: '黑客与画家' },
                { id: '10', title: '算法导论' },
                { id: '11', title: '活着' },
                { id: '12', title: '三体' },
                { id: '13', title: '明朝那些事儿' },
                { id: '14', title: '围城' },
                { id: '15', title: '小王子' }
            ];
            
            favoriteBooks.forEach((bookId, index) => {
                // 查找图书详细信息
                const book = booksData.find(b => b.id === bookId) || { title: `收藏图书 ${bookId}` };
                
                const bookElement = document.createElement('div');
                bookElement.className = 'bg-white rounded-lg p-4 card-shadow';
                bookElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-gray-900">${book.title}</h4>
                            <p class="text-sm text-gray-600 mt-1">收藏日期: 2023-04-${15 + index}</p>
                        </div>
                        <button class="remove-favorite-btn text-red-500 hover:text-red-700 btn-scale" data-id="${bookId}">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                        <span class="badge bg-purple-100 text-purple-800">已收藏</span>
                        <button class="bg-primary hover:bg-primary/90 text-white px-3 py-1 rounded-lg text-sm btn-scale reserve-now-btn" data-id="${bookId}">
                            立即预约
                        </button>
                    </div>
                `;
                favoriteList.appendChild(bookElement);
            });
        }

        // 更新空状态
        function updateEmptyState() {
            const reservations = StorageManager.getReservations().filter(r => !r.completed);
            const borrowedBooks = StorageManager.getBorrowedBooks().filter(b => !b.returned);
            const favorites = StorageManager.getFavoriteBooks();
            
            if (reservations.length === 0 && borrowedBooks.length === 0 && favorites.length === 0) {
                emptyState.classList.remove('hidden');
                recordsContainer.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                recordsContainer.classList.remove('hidden');
            }
        }

        // 绑定事件
        function bindEvents() {
            // 分类标签点击事件
            if (categoryTabs) {
                categoryTabs.addEventListener('click', function(e) {
                    const tabBtn = e.target.closest('.tab-btn');
                    if (tabBtn) {
                        // 移除所有标签的激活状态
                        document.querySelectorAll('.tab-btn').forEach(btn => {
                            btn.classList.remove('bg-primary', 'text-white', 'active');
                            btn.classList.add('text-gray-600');
                        });
                        
                        // 激活当前标签
                        tabBtn.classList.remove('text-gray-600');
                        tabBtn.classList.add('bg-primary', 'text-white', 'active');
                        
                        const tab = tabBtn.getAttribute('data-tab');
                        switchTab(tab);
                    }
                });
            }

            // 关闭逾期提醒横幅
            if (closeOverdueBanner) {
                closeOverdueBanner.addEventListener('click', function() {
                    overdueBanner.classList.add('hidden');
                });
            }

            // 刷新按钮
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    location.reload();
                });
            }

            // 取消预约按钮事件委托
            reservationList.addEventListener('click', function(e) {
                if (e.target.closest('.cancel-reservation-btn')) {
                    const bookId = e.target.closest('.cancel-reservation-btn').getAttribute('data-id');
                    cancelReservation(bookId);
                }
                
                if (e.target.closest('.borrow-now-btn')) {
                    const bookId = e.target.closest('.borrow-now-btn').getAttribute('data-id');
                    borrowNow(bookId);
                }
            });

            // 还书按钮事件委托
            overdueList.addEventListener('click', function(e) {
                if (e.target.closest('.return-book-btn')) {
                    const bookId = e.target.closest('.return-book-btn').getAttribute('data-id');
                    returnBook(bookId);
                }
            });

            normalBorrowedList.addEventListener('click', function(e) {
                if (e.target.closest('.return-book-btn')) {
                    const bookId = e.target.closest('.return-book-btn').getAttribute('data-id');
                    returnBook(bookId);
                }
            });

            // 移除收藏按钮事件委托
            favoriteList.addEventListener('click', function(e) {
                if (e.target.closest('.remove-favorite-btn')) {
                    const bookId = e.target.closest('.remove-favorite-btn').getAttribute('data-id');
                    removeFavorite(bookId);
                }
                
                if (e.target.closest('.reserve-now-btn')) {
                    const bookId = e.target.closest('.reserve-now-btn').getAttribute('data-id');
                    reserveNow(bookId);
                }
            });
        }

        // 切换标签
        function switchTab(tab) {
            // 显示对应内容
            switch(tab) {
                case 'all':
                    tabContents.forEach(content => content.classList.remove('hidden'));
                    break;
                case 'reservation':
                    document.getElementById('reservationSection').classList.remove('hidden');
                    document.getElementById('borrowedSection').classList.add('hidden');
                    document.getElementById('favoriteSection').classList.add('hidden');
                    break;
                case 'borrowed':
                    document.getElementById('reservationSection').classList.add('hidden');
                    document.getElementById('borrowedSection').classList.remove('hidden');
                    document.getElementById('favoriteSection').classList.add('hidden');
                    break;
                case 'favorite':
                    document.getElementById('reservationSection').classList.add('hidden');
                    document.getElementById('borrowedSection').classList.add('hidden');
                    document.getElementById('favoriteSection').classList.remove('hidden');
                    break;
            }

            // 更新空状态
            updateEmptyState();
        }

        // 取消预约
        function cancelReservation(bookId) {
            showMessageCardWithConfirm('确定要取消预约吗？', 'warning', () => {
                const reservations = StorageManager.getReservations();
                const index = reservations.findIndex(r => r.bookId === bookId && !r.completed);
                
                if (index !== -1) {
                    // 恢复图书库存数量
                    const book = booksData.find(b => b.id === bookId);
                    if (book) {
                        book.availableCopies += 1;
                    }
                    
                    reservations.splice(index, 1);
                    StorageManager.saveReservations(reservations);
                    
                    // 重新加载内容和统计信息
                    loadContent();
                    updateStats();
                    
                    showMessageCard('预约已取消', 'success');
                }
            });
        }

        // 立即借阅
        function borrowNow(bookId) {
            showMessageCardWithConfirm('确定要借阅这本书吗？请前往图书馆办理实际借阅手续。', 'info', () => {
                // 重新加载内容和统计信息
                loadContent();
                updateStats();
            });
        }

        // 还书
        function returnBook(bookId) {
            const borrowedBooks = StorageManager.getBorrowedBooks();
            const book = borrowedBooks.find(b => b.bookId === bookId && !b.returned);
            
            if (book) {
                const dueDate = new Date(book.dueDate);
                const today = new Date();
                
                // 检查是否逾期
                if (dueDate < today) {
                    const daysOverdue = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                    const fine = (daysOverdue * 0.5).toFixed(1);
                    showMessageCardWithConfirm(`您有逾期罚款 ¥${fine}，确定要归还《${book.bookTitle}》吗？归还后请前往图书馆完成实际还书手续。`, 'warning', () => {
                        // 不在手机端执行实际归还操作，仅提示用户前往图书馆
                        showMessageCard(`《${book.bookTitle}》归还申请已提交！请前往图书馆完成实际还书手续。`, 'success');
                    });
                } else {
                    showMessageCardWithConfirm(`确定要归还《${book.bookTitle}》吗？归还后请前往图书馆完成实际还书手续。`, 'info', () => {
                        // 不在手机端执行实际归还操作，仅提示用户前往图书馆
                        showMessageCard(`《${book.bookTitle}》归还申请已提交！请前往图书馆完成实际还书手续。`, 'success');
                    });
                }
            }
        }

        // 移除收藏
        function removeFavorite(bookId) {
            showMessageCardWithConfirm('确定要移除收藏吗？', 'warning', () => {
                const favorites = StorageManager.getFavoriteBooks();
                const index = favorites.indexOf(bookId);
                
                if (index !== -1) {
                    favorites.splice(index, 1);
                    StorageManager.saveFavoriteBooks(favorites);
                    
                    // 重新加载内容和统计信息
                    loadContent();
                    updateStats();
                    
                    showMessageCard('已移除收藏', 'success');
                }
            });
        }

        // 立即预约
        function reserveNow(bookId) {
            // 获取图书标题（简化处理，实际情况应该从数据源获取完整信息）
            const bookTitle = '图书' + bookId;
            
            // 恢复图书库存数量
            const book = booksData.find(b => b.id === bookId);
            if (book) {
                book.availableCopies += 1;
                // 保存更新后的图书数据到localStorage
                localStorage.setItem('library_books_data', JSON.stringify(booksData));
            }
            
            showMessageCard(`《${bookTitle}》预约成功！请前往图书馆办理借阅手续。`, 'success');
            
            // 重新加载内容和统计信息
            loadContent();
            updateStats();
        }

        // 显示带确认按钮的消息卡片
        function showMessageCardWithConfirm(message, type, onConfirm) {
            // 创建消息卡片元素
            const messageCard = document.createElement('div');
            messageCard.className = 'message-card';
            
            // 根据消息类型设置样式
            let icon = '';
            let bgColor = '';
            let textColor = '';
            
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-white';
                    break;
                case 'info':
                default:
                    icon = '<i class="fas fa-info-circle"></i>';
                    bgColor = 'bg-blue-500';
                    textColor = 'text-white';
                    break;
            }
            
            messageCard.innerHTML = `
                <div class="rounded-lg shadow-lg ${bgColor} ${textColor} p-4 flex flex-col">
                    <div class="flex items-start mb-3">
                        <div class="mr-3 text-xl">${icon}</div>
                        <div class="flex-1">${message}</div>
                        <button class="ml-3 text-xl opacity-75 hover:opacity-100 focus:outline-none message-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="flex space-x-2 justify-end">
                        <button class="cancel-btn px-4 py-2 bg-white/20 rounded hover:bg-white/30 transition-colors btn-scale">
                            取消
                        </button>
                        <button class="confirm-btn px-4 py-2 bg-white text-gray-800 rounded hover:bg-gray-100 transition-colors font-medium btn-scale">
                            确认
                        </button>
                    </div>
                </div>
            `;
            
            // 添加到消息容器
            document.getElementById('messageCardContainer').appendChild(messageCard);
            
            // 显示动画
            setTimeout(() => {
                messageCard.classList.add('show');
            }, 10);
            
            // 绑定关闭事件
            const closeBtn = messageCard.querySelector('.message-close');
            closeBtn.addEventListener('click', () => {
                messageCard.classList.remove('show');
                setTimeout(() => {
                    messageCard.remove();
                }, 300);
            });
            
            // 绑定取消按钮事件
            const cancelBtn = messageCard.querySelector('.cancel-btn');
            cancelBtn.addEventListener('click', () => {
                messageCard.classList.remove('show');
                setTimeout(() => {
                    messageCard.remove();
                }, 300);
            });
            
            // 绑定确认按钮事件
            const confirmBtn = messageCard.querySelector('.confirm-btn');
            confirmBtn.addEventListener('click', () => {
                messageCard.classList.remove('show');
                setTimeout(() => {
                    messageCard.remove();
                    // 执行确认操作
                    if (onConfirm && typeof onConfirm === 'function') {
                        onConfirm();
                    }
                }, 300);
            });
        }

        // 显示消息卡片
        function showMessageCard(message, type = 'info') {
            // 创建消息卡片元素
            const messageCard = document.createElement('div');
            messageCard.className = 'message-card';
            
            // 根据消息类型设置样式
            let icon = '';
            let bgColor = '';
            let textColor = '';
            
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-white';
                    break;
                case 'info':
                default:
                    icon = '<i class="fas fa-info-circle"></i>';
                    bgColor = 'bg-blue-500';
                    textColor = 'text-white';
                    break;
            }
            
            messageCard.innerHTML = `
                <div class="rounded-lg shadow-lg ${bgColor} ${textColor} p-4 flex items-start">
                    <div class="mr-3 text-xl">${icon}</div>
                    <div class="flex-1">${message}</div>
                    <button class="ml-3 text-xl opacity-75 hover:opacity-100 focus:outline-none message-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // 添加到消息容器
            document.getElementById('messageCardContainer').appendChild(messageCard);
            
            // 显示动画
            setTimeout(() => {
                messageCard.classList.add('show');
            }, 10);
            
            // 绑定关闭事件
            const closeBtn = messageCard.querySelector('.message-close');
            closeBtn.addEventListener('click', () => {
                messageCard.classList.remove('show');
                setTimeout(() => {
                    messageCard.remove();
                }, 300);
            });
            
            // 3秒后自动消失
            setTimeout(() => {
                if (messageCard.parentNode) {
                    messageCard.classList.remove('show');
                    setTimeout(() => {
                        messageCard.remove();
                    }, 300);
                }
            }, 3000);
        }

        // 续借图书
        function renewBook(bookId) {
            showMessageCardWithConfirm('确定要续借这本书吗？每本书仅有一次续借机会，续借后借阅期限将延长一个月。', 'info', () => {
                const borrowedBooks = StorageManager.getBorrowedBooks();
                const bookIndex = borrowedBooks.findIndex(b => b.bookId === bookId && !b.returned);
                
                if (bookIndex !== -1) {
                    // 检查是否已经续借过
                    if (borrowedBooks[bookIndex].renewalCount >= 1) {
                        showMessageCard('每本书仅有一次续借机会，该书已续借过。', 'error');
                        return;
                    }
                    
                    // 更新续借次数
                    borrowedBooks[bookIndex].renewalCount = 1;
                    
                    // 更新应还日期（延长一个月）
                    const newDueDate = new Date(borrowedBooks[bookIndex].dueDate);
                    newDueDate.setMonth(newDueDate.getMonth() + 1);
                    borrowedBooks[bookIndex].dueDate = StorageManager.formatDate(newDueDate);
                    
                    // 保存更新
                    StorageManager.saveBorrowedBooks(borrowedBooks);
                    
                    // 重新加载内容和统计信息
                    loadContent();
                    updateStats();
                    
                    showMessageCard('续借成功！借阅期限已延长一个月。', 'success');
                } else {
                    showMessageCard('未找到该借阅记录。', 'error');
                }
            });
        }

    </script>
</body>
</html>
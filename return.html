<!DOCTYPE html>
<html lang='zh-CN'>
<head>
    <meta charset='UTF-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <title>图书归还 - 雀语图书馆</title>
    <script src='https://cdn.tailwindcss.com'></script>
    <link href='https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css' rel='stylesheet' />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#34D399',
                        // 清新绿色主色调
                        secondary: '#10B981',
                        // 深一点的绿色
                        accent: '#059669',
                        // 强调色
                        light: '#ECFDF5',
                        // 浅色背景
                        dark: '#1E293B', // 深色文字
                        warning: '#FBBF24', // 警告色（逾期）
                        danger: '#EF4444' // 危险色（严重逾期）
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'scale-in': 'scaleIn 0.3s ease-out forwards',
                        'pulse-light': 'pulseLight 2s infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': {
                                opacity: '0'
                            },
                            '100%': {
                                opacity: '1'
                            }
                        },
                        slideUp: {
                            '0%': {
                                transform: 'translateY(10px)',
                                opacity: '0'
                            },
                            '100%': {
                                transform: 'translateY(0)',
                                opacity: '1'
                            }
                        },
                        scaleIn: {
                            '0%': {
                                transform: 'scale(0.98)',
                                opacity: '0'
                            },
                            '100%': {
                                transform: 'scale(1)',
                                opacity: '1'
                            }
                        },
                        pulseLight: {
                            '0%, 100%': {
                                opacity: '1'
                            },
                            '50%': {
                                opacity: '0.8'
                            }
                        }
                    }
                }
            }
        };
    </script>
    <style type='text/tailwindcss'>
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .bg-gradient-green {
                background: linear-gradient(135deg, #34D399 0%, #10B981 100%);
            }
            .card-shadow {
                box-shadow: 0 4px 6px -1px rgba(52, 211, 153, 0.1), 0 2px 4px -1px rgba(52, 211, 153, 0.06);
            }
            .btn-hover {
                @apply hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300;
            }
            .book-item {
                @apply bg-white rounded-xl p-4 shadow-sm mb-4 transition-all duration-300 hover:shadow-md;
            }
            .overdue-warning {
                @apply bg-warning/10 border-warning/30 text-warning;
            }
            .overdue-danger {
                @apply bg-danger/10 border-danger/30 text-danger;
            }
            .on-time {
                @apply bg-primary/10 border-primary/30 text-primary;
            }
        }
    </style>
</head>
<body class='bg-light min-h-screen pb-20'>
    <!-- 顶部导航栏 -->
    <header class='sticky top-0 z-30 bg-white shadow-sm py-3 px-4 flex items-center'>
        <button id='backBtn' class='w-10 h-10 flex items-center justify-center text-gray-700 rounded-full hover:bg-gray-100 transition-colors'>
            <i class='fas fa-arrow-left'></i>
        </button>
        <h1 class='text-lg font-medium text-center flex-1'>图书归还</h1>
        <div class='w-10'></div> <!-- 占位，保持标题居中 -->
    </header>

    <!-- 主内容区 -->
    <main class='px-4 py-5'>
        <!-- 归还规则说明 -->
        <div class='bg-primary/5 rounded-xl p-4 mb-6 border border-primary/20'>
            <h3 class='text-sm font-medium text-primary mb-2 flex items-center'>
                <i class='fas fa-info-circle mr-2'></i>
                归还规则
            </h3>
            <ul class='text-xs text-gray-600 space-y-1'>
                <li>• 请在借阅期限内归还图书，避免产生逾期费用</li>
                <li>• 逾期罚款标准：0.5元/天/本</li>
                <li>• 请确保图书完好无损，如有损坏将按原价赔偿</li>
                <li>• 归还时请检查图书是否有缺页、污渍等情况</li>
            </ul>
        </div>

        <!-- 逾期提醒卡片 -->
        <div id='overdueAlert' class='hidden bg-warning/10 rounded-xl p-4 mb-6 border border-warning/30 animate-pulse-light'>
            <div class='flex items-start'>
                <i class='fas fa-exclamation-triangle text-warning mt-0.5 mr-3 text-lg'></i>
                <div>
                    <h3 class='text-sm font-medium text-warning mb-1'>您有图书即将逾期或已逾期</h3>
                    <p class='text-xs text-warning/80'>请尽快归还逾期图书，避免产生更多罚款</p>
                </div>
            </div>
        </div>

        <!-- 借阅统计 -->
        <div class='grid grid-cols-3 gap-3 mb-6'>
            <div class='bg-white rounded-xl p-3 shadow-sm text-center'>
                <p id='totalBorrowed' class='text-2xl font-bold text-primary'>0</p>
                <p class='text-xs text-gray-500 mt-1'>总借阅</p>
            </div>
            <div class='bg-white rounded-xl p-3 shadow-sm text-center'>
                <p id='onTimeBooks' class='text-2xl font-bold text-primary'>0</p>
                <p class='text-xs text-gray-500 mt-1'>正常</p>
            </div>
            <div class='bg-white rounded-xl p-3 shadow-sm text-center'>
                <p id='overdueBooks' class='text-2xl font-bold text-warning'>0</p>
                <p class='text-xs text-gray-500 mt-1'>逾期</p>
            </div>
        </div>

        <!-- 待归还图书列表 -->
        <div class='mb-8'>
            <div class='flex justify-between items-center mb-4'>
                <h2 class='text-base font-medium'>待归还图书</h2>
                <div class='text-xs text-gray-500' id='totalFine'>总计罚款: ¥0.00</div>
            </div>
            
            <div id='borrowedBooksList' class='space-y-4'>
                <!-- 空状态 -->
                <div id='emptyState' class='text-center py-12 hidden'>
                    <i class='fas fa-book-reader text-gray-300 text-5xl mb-4'></i>
                    <p class='text-gray-500 mb-2'>暂无待归还图书</p>
                    <p class='text-xs text-gray-400'>去借阅一些好书吧！</p>
                    <button id='goBorrowBtn' class='mt-4 px-6 py-2 bg-primary text-white rounded-lg text-sm font-medium'>
                        去借阅
                    </button>
                </div>
                
                <!-- 加载状态 -->
                <div id='loadingState' class='space-y-4'>
                    <div class='bg-white rounded-xl p-4 shadow-sm animate-pulse'>
                        <div class='flex space-x-4'>
                            <div class='w-16 h-24 bg-gray-100 rounded-lg'></div>
                            <div class='flex-1 space-y-2'>
                                <div class='h-5 bg-gray-100 rounded w-3/4'></div>
                                <div class='h-4 bg-gray-100 rounded w-1/2'></div>
                                <div class='h-4 bg-gray-100 rounded w-1/3'></div>
                                <div class='h-4 bg-gray-100 rounded w-1/4'></div>
                                <div class='flex space-x-2 mt-2'>
                                    <div class='h-8 bg-gray-100 rounded flex-1'></div>
                                    <div class='h-8 bg-gray-100 rounded w-24'></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class='bg-white rounded-xl p-4 shadow-sm animate-pulse'>
                        <div class='flex space-x-4'>
                            <div class='w-16 h-24 bg-gray-100 rounded-lg'></div>
                            <div class='flex-1 space-y-2'>
                                <div class='h-5 bg-gray-100 rounded w-3/4'></div>
                                <div class='h-4 bg-gray-100 rounded w-1/2'></div>
                                <div class='h-4 bg-gray-100 rounded w-1/3'></div>
                                <div class='h-4 bg-gray-100 rounded w-1/4'></div>
                                <div class='flex space-x-2 mt-2'>
                                    <div class='h-8 bg-gray-100 rounded flex-1'></div>
                                    <div class='h-8 bg-gray-100 rounded w-24'></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 批量归还按钮 -->
        <div id='batchReturnContainer' class='hidden mb-6'>
            <button id='batchReturnBtn' class='w-full py-3 bg-primary text-white rounded-xl font-medium text-center flex items-center justify-center space-x-2 btn-hover'>
                <i class='fas fa-undo-alt'></i>
                <span>批量归还选中图书</span>
            </button>
        </div>
    </main>

    <!-- 确认归还弹窗 -->
    <div id='returnModal' class='fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden'>
        <div class='bg-white rounded-xl w-4/5 max-w-sm p-5 transform transition-all animate-scale-in'>
            <h3 class='text-lg font-medium text-center mb-4'>确认归还</h3>
            <p class='text-sm text-gray-600 text-center mb-6'>确定要归还这本图书吗？</p>
            <p id='fineInfo' class='text-sm text-warning text-center mb-6 hidden'></p>
            <div class='flex space-x-3'>
                <button id='cancelReturnBtn' class='flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium text-center'>
                    取消
                </button>
                <button id='confirmReturnBtn' class='flex-1 py-2.5 bg-primary text-white rounded-lg font-medium text-center btn-hover'>
                    确认归还
                </button>
            </div>
        </div>
    </div>

    <!-- 引入存储管理模块 -->
    <script src='utils/storage.js'></script>
    <!-- 加载通用底部导航栏 -->
    <script src='components/load-components.js'></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 当前待归还的图书ID
            let currentBookToReturn = null;
            let selectedBooks = new Set();

            // 计算逾期天数和费用
            function calculateOverdueInfo(borrowDate) {
                const borrowTime = new Date(borrowDate).getTime();
                const now = new Date().getTime();
                const borrowDays = Math.floor((now - borrowTime) / (1000 * 60 * 60 * 24));
                const maxBorrowDays = 30; // 最大借阅天数
                const overdueDays = borrowDays > maxBorrowDays ? borrowDays - maxBorrowDays : 0;
                const finePerDay = 0.5; // 每天罚款
                const fine = overdueDays * finePerDay;
                
                return {
                    borrowDays,
                    overdueDays,
                    fine,
                    isOverdue: overdueDays > 0,
                    isSeverelyOverdue: overdueDays > 10, // 超过10天为严重逾期
                    dueDate: new Date(borrowTime + maxBorrowDays * 24 * 60 * 60 * 1000)
                };
            }

            // 格式化日期
            function formatDate(date) {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // 获取逾期状态类名
            function getOverdueStatusClass(overdueInfo) {
                if (overdueInfo.isOverdue) {
                    return overdueInfo.isSeverelyOverdue ? 'overdue-danger' : 'overdue-warning';
                }
                return 'on-time';
            }

            // 获取逾期状态文本
            function getOverdueStatusText(overdueInfo) {
                if (overdueInfo.isOverdue) {
                    return `逾期 ${overdueInfo.overdueDays} 天`;
                }
                const daysLeft = 30 - overdueInfo.borrowDays;
                return `剩余 ${daysLeft} 天`;
            }

            // 渲染借阅图书列表
            function renderBorrowedBooks() {
                // 已移除登录检查，简化用户体验

                const borrowedBooks = StorageManager.getBorrowedBooks();
                const borrowedBooksList = document.getElementById('borrowedBooksList');
                const emptyState = document.getElementById('emptyState');
                const loadingState = document.getElementById('loadingState');
                const overdueAlert = document.getElementById('overdueAlert');
                const batchReturnContainer = document.getElementById('batchReturnContainer');
                
                // 初始化统计数据
                let totalFine = 0;
                let onTimeCount = 0;
                let overdueCount = 0;
                let hasOverdue = false;

                // 隐藏加载状态
                loadingState.classList.add('hidden');

                if (borrowedBooks.length === 0) {
                    // 显示空状态
                    emptyState.classList.remove('hidden');
                    overdueAlert.classList.add('hidden');
                    batchReturnContainer.classList.add('hidden');
                } else {
                    // 隐藏空状态，显示列表
                    emptyState.classList.add('hidden');
                    
                    // 计算统计数据
                    borrowedBooks.forEach(book => {
                        const overdueInfo = calculateOverdueInfo(book.borrowDate);
                        totalFine += overdueInfo.fine;
                        
                        if (overdueInfo.isOverdue) {
                            overdueCount++;
                            hasOverdue = true;
                        } else {
                            onTimeCount++;
                        }
                    });

                    // 更新统计显示
                    document.getElementById('totalBorrowed').textContent = borrowedBooks.length;
                    document.getElementById('onTimeBooks').textContent = onTimeCount;
                    document.getElementById('overdueBooks').textContent = overdueCount;
                    document.getElementById('totalFine').textContent = `总计罚款: ¥${totalFine.toFixed(2)}`;

                    // 显示逾期提醒
                    if (hasOverdue) {
                        overdueAlert.classList.remove('hidden');
                    } else {
                        overdueAlert.classList.add('hidden');
                    }

                    // 显示批量归还按钮
                    batchReturnContainer.classList.remove('hidden');

                    // 清空列表
                    borrowedBooksList.innerHTML = '';
                    
                    // 添加图书项
                    borrowedBooks.forEach(book => {
                        const overdueInfo = calculateOverdueInfo(book.borrowDate);
                        const overdueClass = getOverdueStatusClass(overdueInfo);
                        const overdueText = getOverdueStatusText(overdueInfo);
                        
                        const bookItem = document.createElement('div');
                        bookItem.className = 'book-item animate-fade-in';
                        bookItem.setAttribute('data-id', book.id);
                        bookItem.innerHTML = `
                            <div class='flex space-x-4'>
                                <div class='w-16 h-24 bg-gray-100 rounded-lg overflow-hidden shadow-sm flex-shrink-0'>
                                    <img src='${book.cover}' alt='${book.title}' class='w-full h-full object-cover'>
                                </div>
                                <div class='flex-1 flex flex-col justify-between'>
                                    <div>
                                        <h3 class='text-base font-medium mb-1 truncate'>${book.title}</h3>
                                        <p class='text-gray-600 text-sm mb-1'>${book.author}</p>
                                        <div class='flex items-center mb-1'>
                                            <span class='text-xs px-2 py-1 rounded-full ${overdueClass}'>${overdueText}</span>
                                            ${overdueInfo.isOverdue ? 
                                                `<span class='text-xs text-warning ml-2'>罚款: ¥${overdueInfo.fine.toFixed(2)}</span>` : ''
                                            }
                                        </div>
                                        <div class='flex items-center text-xs text-gray-500'>
                                            <span>借阅日期: ${formatDate(book.borrowDate)}</span>
                                        </div>
                                    </div>
                                    <div class='flex space-x-2 mt-2'>
                                        <label class='flex items-center justify-center w-5 h-5 rounded-full border border-gray-300 cursor-pointer flex-shrink-0'>
                                            <input type='checkbox' class='book-checkbox sr-only' value='${book.id}'>
                                            <i class='fas fa-check text-primary text-xs opacity-0'></i>
                                        </label>
                                        <button class='return-btn py-1.5 bg-primary text-white rounded-lg text-sm font-medium text-center flex-1 btn-hover' data-id='${book.id}'>
                                            归还
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        borrowedBooksList.appendChild(bookItem);
                    });

                    // 添加事件监听器
                    attachEventListeners();
                }
            }

            // 添加事件监听器
            function attachEventListeners() {
                // 归还按钮事件
                document.querySelectorAll('.return-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const bookId = parseInt(this.getAttribute('data-id'));
                        showReturnModal(bookId);
                    });
                });

                // 复选框事件
                document.querySelectorAll('.book-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const bookId = parseInt(this.value);
                        const checkIcon = this.parentElement.querySelector('i');
                        
                        if (this.checked) {
                            selectedBooks.add(bookId);
                            checkIcon.classList.remove('opacity-0');
                            this.parentElement.classList.add('border-primary', 'bg-primary/10');
                        } else {
                            selectedBooks.delete(bookId);
                            checkIcon.classList.add('opacity-0');
                            this.parentElement.classList.remove('border-primary', 'bg-primary/10');
                        }
                    });
                });
            }

            // 显示归还确认弹窗
            function showReturnModal(bookId) {
                currentBookToReturn = bookId;
                const modal = document.getElementById('returnModal');
                const fineInfo = document.getElementById('fineInfo');
                
                // 获取图书借阅信息
                const borrowedBooks = StorageManager.getBorrowedBooks();
                const book = borrowedBooks.find(b => b.id === bookId);
                
                if (book) {
                    const overdueInfo = calculateOverdueInfo(book.borrowDate);
                    
                    // 更新弹窗信息
                    if (overdueInfo.isOverdue) {
                        fineInfo.textContent = `该书已逾期 ${overdueInfo.overdueDays} 天，需支付罚款 ¥${overdueInfo.fine.toFixed(2)}`;
                        fineInfo.classList.remove('hidden');
                    } else {
                        fineInfo.classList.add('hidden');
                    }
                }
                
                // 显示弹窗
                modal.classList.remove('hidden');
            }

            // 隐藏归还确认弹窗
            function hideReturnModal() {
                const modal = document.getElementById('returnModal');
                modal.classList.add('hidden');
                currentBookToReturn = null;
            }

            // 处理图书归还
            function handleReturnBook(bookId) {
                if (StorageManager.removeBorrowRecord(bookId)) {
                    showToast('归还成功！');
                    // 重新渲染列表
                    setTimeout(() => {
                        renderBorrowedBooks();
                        selectedBooks.clear();
                    }, 1500);
                } else {
                    showToast('归还失败，请稍后重试', 'error');
                }
            }

            // 处理批量归还
            function handleBatchReturn() {
                if (selectedBooks.size === 0) {
                    showToast('请先选择要归还的图书', 'info');
                    return;
                }

                // 计算总罚款
                let totalFine = 0;
                const borrowedBooks = StorageManager.getBorrowedBooks();
                
                selectedBooks.forEach(bookId => {
                    const book = borrowedBooks.find(b => b.id === bookId);
                    if (book) {
                        const overdueInfo = calculateOverdueInfo(book.borrowDate);
                        totalFine += overdueInfo.fine;
                    }
                });

                // 显示确认消息
                let confirmMessage = `确定要归还选中的 ${selectedBooks.size} 本图书吗？`;
                if (totalFine > 0) {
                    confirmMessage += `\n需支付罚款 ¥${totalFine.toFixed(2)}`;
                }

                if (confirm(confirmMessage)) {
                    // 执行批量归还
                    let successCount = 0;
                    selectedBooks.forEach(bookId => {
                        if (StorageManager.removeBorrowRecord(bookId)) {
                            successCount++;
                        }
                    });

                    showToast(`成功归还 ${successCount} 本图书！`);
                    
                    // 重新渲染列表
                    setTimeout(() => {
                        renderBorrowedBooks();
                        selectedBooks.clear();
                    }, 1500);
                }
            }

            // Toast提示函数
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-md text-white ${type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-500' : 'bg-primary'} transition-opacity duration-300 z-50`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 2000);
            }

            // 事件监听器设置
            function setupEventListeners() {
                // 返回按钮
                document.getElementById('backBtn').addEventListener('click', function() {
                    window.history.back();
                });

                // 去借阅按钮
                document.getElementById('goBorrowBtn').addEventListener('click', function() {
                    window.location.href = 'borrow.html';
                });

                // 取消归还
                document.getElementById('cancelReturnBtn').addEventListener('click', hideReturnModal);

                // 确认归还
                document.getElementById('confirmReturnBtn').addEventListener('click', function() {
                    if (currentBookToReturn !== null) {
                        handleReturnBook(currentBookToReturn);
                        hideReturnModal();
                    }
                });

                // 批量归还按钮
                document.getElementById('batchReturnBtn').addEventListener('click', handleBatchReturn);
            }

            // 初始化
            function init() {
                setupEventListeners();
                
                // 延迟加载，模拟网络请求
                setTimeout(() => {
                    renderBorrowedBooks();
                }, 800);
            }

            init();
        });
    </script>
</body>
</html>